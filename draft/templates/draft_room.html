{% extends "head.html" %}
{% load static %}
{% block title %}{{draft.match_name}} | 밴픽 도우미{% endblock title %}
{% block body %}
<body>
    <div id="app">
        <div id="home_logo" class="t_center">
            <img class="block center" src="{% static 'img/home_logo.png' %}">
        </div>
        <div id="timer_wrap" class="t_center bold">
            <div class="turn blue">
                <p>{{draft.blue_team_name}}</p><div class="bar"></div>
            </div>
            <div id="timer">[[timer | timerShow]]</div>
            <div class="turn red">
                <p>{{draft.red_team_name}}</p><div class="bar"></div>
            </div>                    
        </div>
        <div id="room_wrap">
            <div id="team_wrap">
                <div class="team blue">
                    <div class="ban">
                        <div class="container od_0">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_2">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_4">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_13">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_15">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                    </div>
                    <div class="pick">
                        <div class="container od_6">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_9">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_10">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_17">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_18">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="draft_wrap">
                <div id="champion_filter">
                    <input id="cpf-all" type="radio" name="lane" @change="championsRefresh()" value="">
                    <label for="cpf-all">전체</label>
                    <input id="cpf-top" type="radio" name="lane" @change="championsRefresh()" value="탑">
                    <label for="cpf-top">탑</label>
                    <input id="cpf-jg" type="radio" name="lane" @change="championsRefresh()" value="정글">
                    <label for="cpf-jg">정글</label>
                    <input id="cpf-mid" type="radio" name="lane" @change="championsRefresh()" value="미드">
                    <label for="cpf-mid">미드</label>
                    <input id="cpf-adc" type="radio" name="lane" @change="championsRefresh()" value="원딜">
                    <label for="cpf-adc">원딜</label>
                    <input id="cpf-sup" type="radio" name="lane" @change="championsRefresh()" value="서포터">
                    <label for="cpf-sup">서포터</label>
                    <input id="cpf-search" type="text" @keyup="championsRefresh()" name="name">
                </div>
                <div id="champion_list" class="after bg_black">
                    <div v-for="champion in champions" class="champion f_left">
                        <i @click="draftSelect(champion.no)" :style="champion.no|cpStyle" class="block sp" :class="champion.no|cpClassName" :disabled="champion.disabled">
                            <div class="sp-name t_center">
                                <p class="inline-block">[[champion.name]]</p>
                            </div>
                        </i>
                    </div>
                </div>
                <div id="champion_select" v-if="draft.team == '{{request.session.team}}'" :class="draft.order|selectClassName" @click="draftChoice()">
                    <p class="t_center">[[order|selectHtml]]</p>
                </div>
            </div>
            <div id="team_wrap">
                <div class="team red">
                    <div class="ban">
                        <div class="container od_1">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_3">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_5">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_12">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_14">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                    </div>
                    <div class="pick">
                        <div class="container od_7">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_8">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_11">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_16">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                        <div class="container od_19">
                            <div class="sp"></div>
                            <span class="bar"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="modal" v-if="!start">
            <div id="start_wrap"{% if request.session.master == draft.id %} @click="draftStart">시작하기{% else %}>대기중 ...{% endif %}</div>
        </div>
    </div>
    <script>
    var roomId = "{{ draft.id|escapejs }}";

    var draftSocket = new WebSocket(
        'ws://' + window.location.host + 
        ':6379/ws/draft/' + roomId + '/');

    var draft = new Vue({
        el:"#app",
        delimiters:['[[',']]'],
        data:{
            timer:0,
            start:false,
            order:0,
            draft:{
                banpick:'',
                temp:'',
                team:'blue'
            },
            champions:''
        },
        watch: {
            {% if request.session.master == draft.id %}
            timer:function(newTimer, oldTimer){
                if(this.start && parseInt(newTimer/28) == 1 && newTimer % 28 == 0){
                    this.draft.temp = Math.floor(Math.random() * 147) + 1
                    this.draftChoice();
                }
            },
            {% endif %}
            order:function(newOrder, oldOrder){
                var blue = [0, 2, 4, 6, 9, 10, 13, 15, 17, 18]
                if(blue.includes(newOrder)){
                    this.draft.team = 'blue'
                }else{
                    this.draft.team = 'red'
                }
            }
        },
        filters:{
            timerShow:function(time){
                return 27 - (time % 28)
            },
            selectClassName:function(order){
                return ([0,1,2,3,4,5,12,13,14,15].includes(order)) ? 'ban' : 'pick'
            },
            selectHtml:function(order){
                return ([0,1,2,3,4,5,12,13,14,15].includes(order)) ? '금지하기' : '선택하기'
            },
            cpClassName:function(no){
                return 'sp-' + no
            },
            cpStyle:function(no){
                return "backgroundPosition:0px -" + String(Number(no)*82) + "px;";
            }
        },
        created:function(){
            this.draftRefresh();
            this.championsRefresh();
        },
        methods:{
            draftStart:function(){
                var self = this;
                axios.post('/draft/draft/{{draft.id}}', {no:''}, {xsrfCookieName: 'csrftoken', xsrfHeaderName: 'X-CSRFToken'})
                .then(function(response){
                    self.draftRefresh();
                    self.championsRefresh();
                    self.countDownTimer()
                })
            },
            championsRefresh:function(){
                var self = this;
                var lane = (document.querySelector("input[name='lane']:checked")) ? document.querySelector("input[name='lane']:checked").value : '';
                var name = document.querySelector("input[name='name']") ? document.querySelector("input[name='name']").value : '';
                var draft = '{{draft.id}}'
                axios.get('/draft/champion?lane=' + lane + '&name=' + name + '&draft=' + draft)
                .then(function(response){
                    self.champions = response.data;
                })
            },
            draftRefresh:function(){
                var self = this;
                var now = Math.floor(Date.now()/1000)
                console.log(now)
                axios.get('/draft/draft/{{draft.id}}')
                .then(function(response){
                    if(response.data.start){
                        self.timer = now-response.data.start;
                        self.start = true;
                    };
                    if(self.timer > 0){
                        self.countDownTimer()
                    }
                    if(response.data.banpick != [""]){
                        banpick = response.data.banpick.split('/');
                        self.draft.banpick = banpick;
                        self.order = banpick.length;
                        for(var i = 0; i < banpick.length; i++){
                            var el = document.querySelector('.od_' + String(i) + ' .sp');
                            el.style.backgroundImage = 'url(/assets/img/champion82.png)';
                            el.style.backgroundPosition = '0px -' + String(banpick[i] * 52) + 'px';
                        };
                    };
                    if(document.querySelector('.team .container.now')){
                        document.querySelector('.team .container.now').classList.remove('now');
                    }
                    document.querySelector('.od_' + self.order).classList.add('now');
                    if(document.querySelector('.team .container.next')){
                        document.querySelector('.team .container.next').classList.remove('next');
                    }
                    document.querySelector('.od_' + String(self.order+1)).classList.add('next');
                })
            },
            timerStart:function(){
                if(this.timer > 0){
                };
            },
            draftSelect:function(no){
                el2 = document.querySelector('.sp-' + String(no));
                if(el2.hasAttribute('disabled')){
                    return false;
                }
                this.draft.temp = String(no);
                el1 = document.querySelector('.sp.selected');
                if(el1){
                    el1.classList.remove('selected')
                }
                el2.classList.add('selected')
            },
            draftChoice:function(){
                var self = this;
                var order = this.order;
                var no = this.draft.temp;
                if(no){
                    var postData = {no: no};
                    axios.post('/draft/draft/{{draft.id}}', postData, {xsrfCookieName: 'csrftoken', xsrfHeaderName: 'X-CSRFToken'})
                    .then(function(response){
                        self.draftRefresh();
                        el = document.querySelector('.sp-' + no);
                        el.classList.remove('selected');
                        el.setAttribute("disabled", "disabled");
                        self.order++;
                        if(document.querySelector("input[name='name']").value){
                            document.querySelector("input[name='name']").value == '';
                        }
                        if(document.querySelector("input[name='lane']:checked")){
                            document.querySelector("input[name='lane']:checked").checked = false;
                        }
                        self.championsRefresh();
                    })
                }
            },
            countDown:function(){
                this.timer += 1;
            },
            countDownTimer:function(){
                setInterval(this.countDown, 1000)
            },
            test:function(){
                draftSocket.send(JSON.stringify({
                'message': 'asd'
                }));
            }
        }
    })
    draftSocket.onopen = function (e) {
      console.log("연결 성공");
    };

    draftSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        console.log(message)
    };
    </script>
</body>
{% endblock body %}